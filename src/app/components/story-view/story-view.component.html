<div class="story-view">
  @if (isDebugMode()) {
    <div class="debug-panel">
      <div class="debug-header">Debug Mode</div>
      <div class="debug-controls">
        <select class="debug-select" (change)="onDebugNavigate($any($event.target).value)">
          <option value="" disabled selected>Jump to node...</option>
          @for (node of allNodes(); track node.id) {
            <option [value]="node.id" [class.current]="node.id === currentNode()?.id">
              {{ node.title }}
            </option>
          }
        </select>
        <button class="debug-btn reset" (click)="onDebugReset()">Reset All</button>
      </div>
    </div>
  }

  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Das Abenteuerbuch wird geöffnet...</p>
    </div>
  } @else if (error()) {
    <div class="error-box">
      <p>{{ error() }}</p>
      <button class="retry-btn" (click)="onRestart()">Nochmal versuchen</button>
    </div>
  } @else {
    @if (currentNode(); as node) {
      <article class="story-card">
        @if (node.title) {
          <h1 class="story-title">{{ node.title }}</h1>
        }

        @if (!node.pending) {
          <!-- Paragraphs before image (for middle/bottom position) -->
          @if (paragraphsBeforeImage().length > 0) {
            <div class="story-text">
              @for (paragraph of paragraphsBeforeImage(); track $index) {
                <p>{{ paragraph }}</p>
              }
            </div>
          }

          <!-- Image -->
          @if (node.media?.image) {
            <div class="story-image">
              <img [src]="node.media!.image!" [alt]="node.title || 'Story illustration'" />
            </div>
          }

          <!-- Paragraphs after image (for top/middle position) -->
          @if (paragraphsAfterImage().length > 0) {
            <div class="story-text" [class.story-text-continued]="paragraphsBeforeImage().length > 0">
              @for (paragraph of paragraphsAfterImage(); track $index) {
                <p>{{ paragraph }}</p>
              }
            </div>
          }

          @if (node.media?.audio) {
            <app-audio-player [src]="node.media!.audio!" />
          }
        }

        @if (node.pending) {
          @if (node.teaser) {
            <div class="story-text teaser-text">
              <p>{{ node.teaser }}</p>
            </div>
          }
          <div class="pending-message">
            <div class="hourglass">&#9203;</div>
            <p>Fortsetzung folgt...</p>
            <p class="subtext">Schau bald wieder vorbei für den nächsten Teil deines Abenteuers!</p>
          </div>

          <!-- Story so far button -->
          @if (storyHistory().length > 1) {
            <button class="history-toggle" (click)="toggleHistory()">
              @if (showHistory()) {
                <span>&#9650; Geschichte ausblenden</span>
              } @else {
                <span>&#9660; Die Geschichte bisher lesen</span>
              }
            </button>

            @if (showHistory()) {
              <!-- Sticky chapter navigation -->
              <nav class="chapter-nav">
                @for (entry of storyHistory(); track $index; let isLast = $last) {
                  @if (!isLast) {
                    <button
                      class="chapter-dot"
                      [class.active]="activeChapterIndex() === $index"
                      (click)="scrollToChapter($index)"
                      [title]="entry.node.title || 'Kapitel ' + ($index + 1)"
                    >
                      <span class="dot"></span>
                      <span class="chapter-label">{{ entry.node.title || 'Kapitel ' + ($index + 1) }}</span>
                    </button>
                  }
                }
              </nav>

              <div class="story-history">
                @for (entry of storyHistory(); track $index; let isLast = $last) {
                  @if (!isLast) {
                    <div class="history-entry" #historyChapter [attr.data-index]="$index">
                      @if (entry.node.title) {
                        <h2 class="history-title">{{ entry.node.title }}</h2>
                      }
                      <div class="history-text">
                        @for (paragraph of entry.node.text.split('\n\n'); track $index) {
                          <p>{{ paragraph }}</p>
                        }
                      </div>
                      @if (entry.choiceText && entry.wasRealChoice) {
                        <div class="history-choice">
                          <span class="choice-label">Du hast gewählt:</span>
                          <span class="choice-text">"{{ entry.choiceText }}"</span>
                        </div>
                      }
                    </div>
                  }
                }
              </div>
            }
          }
        } @else if (node.openQuestion) {
          <!-- Open question -->
          <div class="open-question">
            <p class="question-prompt">{{ node.openQuestion.prompt }}</p>
            @if (isCurrentNodeAnswered()) {
              <div class="pending-message">
                <div class="hourglass">&#9203;</div>
                <p>Deine Antwort wurde gesendet!</p>
                <p class="subtext">Schau bald wieder vorbei für die Fortsetzung...</p>
              </div>
            } @else if (isReaderMode()) {
              <p class="reader-waiting-text">Warte auf die Antwort...</p>
            } @else {
              <textarea
                class="answer-input"
                [(ngModel)]="openAnswer"
                placeholder="Schreibe deine Antwort..."
                rows="3"
                [disabled]="isChoosing()"
              ></textarea>
              <button
                class="submit-btn"
                (click)="onOpenAnswerSubmit(node.openQuestion)"
                [disabled]="isChoosing() || !openAnswer().trim()"
              >
                Antwort senden
              </button>
            }
          </div>
        } @else if (node.choices.length > 0) {
          <div class="choices">
            @if (node.choices.length > 1) {
              @if (isReaderMode()) {
                <p class="choices-prompt reader-prompt">Warte auf die nächste Entscheidung...</p>
              } @else {
                <p class="choices-prompt">Was machst du?</p>
              }
            }
            @for (choice of node.choices; track choice.id) {
              <button
                class="choice-btn"
                (click)="onChoiceClick(choice)"
                [disabled]="isChoosing() || (isReaderMode() && node.choices.length > 1)"
              >
                {{ choice.text }}
              </button>
            }
          </div>
        } @else {
          <div class="story-end">
            <p>Ende</p>
            <button class="restart-btn" (click)="onRestart()">
              Ein neues Abenteuer starten
            </button>
          </div>
        }
      </article>
    }
  }
</div>
